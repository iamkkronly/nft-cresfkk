<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NFT Marketplace</title>
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js "></script>
  <!-- Web3.js for Ethereum interaction -->
  <script src="https://cdn.jsdelivr.net/npm/web3 @1.8.2/dist/web3.min.js"></script>
  <style>
    /* Basic styling - replace with Tailwind or Bootstrap if needed */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: sans-serif;
    }
    body {
      background-color: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      padding: 16px;
    }
    .container {
      max-width: 500px;
      margin: auto;
    }
    button {
      width: 100%;
      padding: 12px;
      background-color: var(--tg-theme-button-color);
      color: var(--tg-theme-button-text-color);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
    }
    .wallet-info {
      background-color: var(--tg-theme-secondary-bg-color);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .tab-buttons {
      display: flex;
      justify-content: space-around;
      margin-bottom: 10px;
    }
    .tab-buttons div {
      cursor: pointer;
      padding: 10px;
      font-weight: bold;
    }
    .active-tab {
      border-bottom: 2px solid var(--tg-theme-button-color);
    }
    .nft-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
    }
    .nft-item {
      border: 1px solid #ccc;
      border-radius: 8px;
      overflow: hidden;
      text-align: center;
      padding: 8px;
    }
    img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
    }
    input[type="file"] {
      display: none;
    }
    .upload-label {
      display: inline-block;
      margin-top: 10px;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 6px;
      cursor: pointer;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>NFT Marketplace</h1>
    <p>Buy, Sell & Create NFTs in Telegram</p>

    <div class="wallet-info" id="walletInfo">
      <p>Wallet: <span id="walletAddress">Not connected</span></p>
      <p>Balance: <span id="walletBalance">0 ETH</span></p>
    </div>
    <button id="connectBtn">Connect MetaMask</button>

    <div class="tab-buttons">
      <div data-tab="marketplace" class="active-tab">Marketplace</div>
      <div data-tab="my-nfts">My NFTs</div>
      <div data-tab="create">Create NFT</div>
    </div>

    <!-- Marketplace Tab -->
    <div id="marketplaceTab" class="tab-content active">
      <div class="nft-grid" id="marketplaceGrid"></div>
    </div>

    <!-- My NFTs Tab -->
    <div id="myNftsTab" class="tab-content hidden">
      <div class="nft-grid" id="myNftsGrid"></div>
    </div>

    <!-- Create NFT Tab -->
    <div id="createTab" class="tab-content hidden">
      <input type="text" id="nftName" placeholder="NFT Name" /><br/>
      <textarea id="nftDescription" placeholder="Description"></textarea><br/>
      <input type="number" id="nftPrice" placeholder="Price in ETH" step="0.001"/><br/>
      <label class="upload-label" for="nftImage">Upload Image</label>
      <input type="file" id="nftImage" accept="image/*" />
      <img id="preview" style="max-width: 100%; margin-top: 10px;" />
      <button onclick="createNFT()">Create NFT</button>
    </div>

    <!-- Detail View -->
    <div id="nftDetail" class="hidden">
      <button onclick="goBack()">‚Üê Back</button>
      <img id="detailImage" style="width: 100%; border-radius: 8px;" />
      <h3 id="detailName"></h3>
      <p id="detailCreator"></p>
      <p id="detailPrice"></p>
      <button id="buyButton">Buy Now</button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    let web3, accounts = [], walletConnected = false;
    let currentNftId = null;

    // Sample NFTs (Replace with real ones from contract)
    let marketplaceNfts = [
      { id: 1, name: 'Cosmic Voyager', price: '0.05', creator: '0x123...def', image: 'https://placehold.co/400 ' },
      { id: 2, name: 'Digital Dreams', price: '0.08', creator: '0xabcd...123', image: 'https://placehold.co/400 ' }
    ];
    let myNfts = [];

    // Tabs
    document.querySelectorAll('.tab-buttons div').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab-buttons div').forEach(t => t.classList.remove('active-tab'));
        tab.classList.add('active-tab');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(`${tab.dataset.tab}Tab`).classList.remove('hidden');
        document.getElementById('nftDetail').classList.add('hidden');
      });
    });

    // Connect Wallet
    async function connectWallet() {
      if (typeof window.ethereum !== 'undefined') {
        try {
          accounts = await ethereum.request({ method: 'eth_requestAccounts' });
          walletConnected = true;
          document.getElementById('walletAddress').textContent = `${accounts[0].substring(0, 6)}...${accounts[0].substring(accounts.length - 4)}`;
          updateBalance();
          initWeb3();
          renderMarketplace();
          tg.MainButton.setText('Go to My NFTs');
          tg.MainButton.onClick(() => document.querySelector('[data-tab="my-nfts"]').click());
          tg.MainButton.show();
        } catch (err) {
          alert('User denied account access');
        }
      } else {
        alert('Please install MetaMask!');
      }
    }

    // Update Balance
    async function updateBalance() {
      const balance = await web3.eth.getBalance(accounts[0]);
      document.getElementById('walletBalance').textContent = `${web3.utils.fromWei(balance, 'ether')} ETH`;
    }

    // Init Web3
    function initWeb3() {
      web3 = new Web3(window.ethereum);
    }

    // Render NFTs
    function renderMarketplace() {
      const grid = document.getElementById('marketplaceGrid');
      grid.innerHTML = '';
      marketplaceNfts.forEach(nft => {
        const el = document.createElement('div');
        el.className = 'nft-item';
        el.innerHTML = `
          <img src="${nft.image}" alt="${nft.name}" />
          <p>${nft.name}</p>
          <p>${nft.price} ETH</p>
        `;
        el.onclick = () => showDetail(nft);
        grid.appendChild(el);
      });
    }

    function renderMyNFTs() {
      const grid = document.getElementById('myNftsGrid');
      grid.innerHTML = '';
      if (myNfts.length === 0) {
        grid.innerHTML = '<p>No NFTs yet.</p>';
        return;
      }
      myNfts.forEach(nft => {
        const el = document.createElement('div');
        el.className = 'nft-item';
        el.innerHTML = `
          <img src="${nft.image}" alt="${nft.name}" />
          <p>${nft.name}</p>
          <p>${nft.price} ETH</p>
        `;
        el.onclick = () => showDetail({...nft, owned: true});
        grid.appendChild(el);
      });
    }

    function showDetail(nft) {
      currentNftId = nft.id;
      document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
      document.getElementById('nftDetail').classList.remove('hidden');
      document.getElementById('detailImage').src = nft.image;
      document.getElementById('detailName').textContent = nft.name;
      document.getElementById('detailCreator').textContent = `By ${nft.creator}`;
      document.getElementById('detailPrice').textContent = `${nft.price} ETH`;

      const buyBtn = document.getElementById('buyButton');
      buyBtn.disabled = !walletConnected || nft.owned;
      buyBtn.textContent = nft.owned ? 'You Own It' : 'Buy Now';
    }

    function goBack() {
      document.getElementById('nftDetail').classList.add('hidden');
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('hidden'));
    }

    // Buy NFT
    async function buyNFT() {
      if (!walletConnected) {
        alert('Connect wallet first.');
        return;
      }
      const nft = marketplaceNfts.find(n => n.id === currentNftId);
      const amount = web3.utils.toWei(nft.price, 'ether');

      try {
        await web3.eth.sendTransaction({
          from: accounts[0],
          to: nft.creator,
          value: amount
        });
        alert('Purchase successful!');
        myNfts.push(nft);
        tg.sendData(JSON.stringify({
          action: 'nft_purchased',
          nft_id: nft.id,
          price: nft.price
        }));
        renderMyNFTs();
        goBack();
      } catch (e) {
        console.error(e);
        alert('Transaction failed.');
      }
    }

    // Create NFT
    async function createNFT() {
      const name = document.getElementById('nftName').value;
      const desc = document.getElementById('nftDescription').value;
      const price = document.getElementById('nftPrice').value;
      const file = document.getElementById('nftImage').files[0];
      if (!name || !desc || !price || !file) {
        alert('Fill all fields and upload an image.');
        return;
      }

      const reader = new FileReader();
      reader.onload = async function () {
        const image = reader.result;
        const newNft = {
          id: Date.now(),
          name,
          description: desc,
          price,
          creator: accounts[0],
          image,
          owned: true
        };
        marketplaceNfts.push(newNft);
        myNfts.push(newNft);
        alert('NFT Created!');
        tg.sendData(JSON.stringify({
          action: 'nft_created',
          nft_id: newNft.id,
          name: newNft.name
        }));
        document.getElementById('nftName').value = '';
        document.getElementById('nftDescription').value = '';
        document.getElementById('nftPrice').value = '';
        document.getElementById('nftImage').value = '';
        document.getElementById('preview').src = '';
        renderMarketplace();
        renderMyNFTs();
        document.querySelector('[data-tab="marketplace"]').click();
      };
      reader.readAsDataURL(file);
    }

    // Events
    document.getElementById('connectBtn').addEventListener('click', connectWallet);
    document.getElementById('buyButton').addEventListener('click', buyNFT);

    // Initial Load
    window.onload = () => {
      if (window.ethereum) {
        window.ethereum.on('accountsChanged', async () => {
          await connectWallet();
        });
      }
    };

    // Telegram Main Button
    tg.MainButton.setText('Connect Wallet');
    tg.MainButton.onClick(connectWallet);
    tg.MainButton.show();
  </script>
</body>
</html>
